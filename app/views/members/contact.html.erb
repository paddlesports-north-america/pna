<h2>Contact Information</h2>
<%= form_for @member, url: '/members/contact-info' do |f| %>

  <div class="form-group">
    <label>Email Address</label>
    <%= f.email_field :email, class: 'form-control' %>
    <p class="hint-block">Changing this address changes your login credentials</p>
  </div>

  <%= f.fields_for :phone_number, @member.phone_numbers.first do |phone_fields| %>
    <div class="form-group">
      <label>Phone Number</label>
      <%= phone_fields.text_field :number, class: 'form-control' %>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.fields_for :address, @member.addresses.first do |address_fields| %>
      <div class="form-group">
        <label>Address</label>
        <%= address_fields.text_field :address1, class: 'form-control' %>
        <br />
        <%= address_fields.text_field :address2, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>City</label>
        <%= address_fields.text_field :city, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>Postal Code</label>
        <%= address_fields.text_field :postal_code, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>Country</label>
        <%= address_fields.select :country_id, grouped_options_for_select( @countries ) %>
      </div>

      <div class="form-group" id="state-group">
        <label>State or Province</label>
        <%= address_fields.select :state_id, @states[ @member.addresses.first.country_id ] %>
      </div>
    <% end %>
  </div>

<% end %>


<script type="text/javascript">
  var states = <%= @states.to_json.html_safe %>;
  var selected_state = <%= @member.addresses.first.state_id %>;

  function filterStates() {
    var cid = parseInt( $( '#member_address_country_id option:selected' ).val() );

    if( states[ cid ] !== undefined ) {
      var state_options = states[ cid ].map( function( state ){
        var opt = '<option value="' + state[ 1 ] + '"';
        if( selected_state === state[ 1 ] ){
          opt += ' selected="selected"';
        }
        return opt + '>' + state[ 0 ] + '</option>';
      }).join('');

      $( '#member_address_state_id' ).html( state_options );
      $( '#state-group' ).show();
      console.log( 'visible' );
      selected_state = null;
    } else {
      $( '#state-group' ).hide();
      $( '#member_address_state_id' ).html('');
    }
  }

  $( document ).on( 'ready', function() {
    // hide state group on load if no states in country
    filterStates();
    $( document ).off( 'ready' );
  });

  $( '#member_address_country_id' ).on( 'change', function(){
    filterStates();
  });
</script>
