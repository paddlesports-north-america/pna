<h2>Contact Information</h2>
<%= form_for @member, url: '/members/contact-info' do |f| %>
  <% if @member.errors.any? %>
    <div class="alert alert-danger">
      <% @member.errors.full_messages.each do |msg| %>
        <p><%= msg %></p>
      <% end %>
    </div>
  <% end %>

  <div class="form-group">
    <label>Email Address</label>
    <%= f.email_field :primary_email, class: 'form-control' %>
    <p class="hint-block">Changing this address changes your login credentials</p>
  </div>


    <div class="form-group">
      <label>Phone Number</label>
      <%= f.telephone_field :primary_phone_number, class: 'form-control' %>
    </div>


  <div class="form-group">
    <%= f.fields_for :primary_address, @member.addresses.first do |address_fields| %>
      <div class="form-group">
        <label>Address</label>
        <%= address_fields.text_field :address1, class: 'form-control' %>
        <br />
        <%= address_fields.text_field :address2, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>City</label>
        <%= address_fields.text_field :city, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>Postal Code</label>
        <%= address_fields.text_field :postal_code, class: 'form-control' %>
      </div>

      <div class="form-group">
        <label>Country</label>
        <%= address_fields.select :country_id, grouped_options_for_select( @countries ), {}, { class: 'form-control country_id' } %>
      </div>

      <div class="form-group" id="state-group">
        <label>State or Province</label>
        <%= address_fields.select :state_id, @states[ @member.addresses.first.country_id ], {}, { class: 'form-control state_id' } %>
      </div>

      <div class="form-group form-btns">
        <%= f.submit 'Update Contact Information', class: 'btn btn-success' %>
        <!-- <input type="hidden" name="ref" value="update" /> -->
        <%= hidden_field_tag 'ref', 'contact' %>
      </div>
    <% end %>
  </div>

<% end %>


<script type="text/javascript">
  var states = <%= @states.to_json.html_safe %>;
  var selected_state = <%= @member.addresses.first.state_id %>;

  function filterStates() {
    var cid = parseInt( $( '.country_id option:selected' ).val() );

    if( states[ cid ] !== undefined ) {
      var state_options = states[ cid ].map( function( state ){
        var opt = '<option value="' + state[ 1 ] + '"';
        if( selected_state === state[ 1 ] ){
          opt += ' selected="selected"';
        }
        return opt + '>' + state[ 0 ] + '</option>';
      }).join('');

      $( '.state_id' ).html( state_options );
      $( '#state-group' ).show();
      console.log( 'visible' );
      selected_state = null;
    } else {
      $( '#state-group' ).hide();
      $( '.state_id' ).html('');
    }
  }

  $( document ).on( 'ready', function() {
    // hide state group on load if no states in country
    filterStates();
    $( document ).off( 'ready' );
  });

  $( '.country_id' ).on( 'change', function(){
    filterStates();
  });
</script>
